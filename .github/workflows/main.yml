name: RDP

on:
  workflow_dispatch:
  schedule:
    # Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ø± 5 Ø³Ø§Ø¹Øª
    - cron: '0 */5 * * *'

jobs:
  secure-rdp:
    runs-on: windows-latest
    # Ù‚Ø·Ø¹ Ø´Ø¯Ù† Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø³ Ø§Ø² 5 Ø³Ø§Ø¹Øª Ùˆ 40 Ø¯Ù‚ÛŒÙ‚Ù‡
    timeout-minutes: 340

    steps:
      - name: Configure Core RDP Settings
        run: |
          # Enable Remote Desktop and disable Network Level Authentication (if needed)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "SecurityLayer" -Value 0 -Force

          # Remove any existing rule with the same name to avoid duplication
          netsh advfirewall firewall delete rule name="RDP-Tailscale"
          
          # For testing, allow any incoming connection on port 3389
          netsh advfirewall firewall add rule name="RDP-Tailscale" `
            dir=in action=allow protocol=TCP localport=3389

          # (Optional) Restart the Remote Desktop service to ensure changes take effect
          Restart-Service -Name TermService -Force

            - name: Create RDP User with FIXED Password
        run: |
          # 1. ØªØ¹Ø±ÛŒÙ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø«Ø§Ø¨Øª Ø§Ø² Secrets GitHub
          $fixedPassword = "${{ secrets.FIXED_RDP_PASSWORD }}"
          
          # 2. Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø³Øª Ø´Ø¯Ù‡ Ø§Ø³Øª
          if ([string]::IsNullOrEmpty($fixedPassword)) {
              Write-Error "âŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø«Ø§Ø¨Øª (FIXED_RDP_PASSWORD) Ø¯Ø± Secrets Ú¯ÛŒØªâ€ŒÙ‡Ø§Ø¨ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª."
              Write-Host "Ù„Ø·ÙØ§Ù‹ Ø¨Ù‡ Settings > Secrets > Actions Ø±ÙØªÙ‡ Ùˆ secret Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯."
              exit 1
          }
          
          # 3. ØªØ¨Ø¯ÛŒÙ„ Ø±Ù…Ø² Ø¨Ù‡ ÙØ±Ù…Øª Secure String
          $securePassword = ConvertTo-SecureString $fixedPassword -AsPlainText -Force
          
          # 4. Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø± 'RDP' Ù‚Ø¯ÛŒÙ…ÛŒ (Ø§Ú¯Ø± Ø§Ø² Ù‚Ø¨Ù„ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯)
          $existingUser = Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue
          if ($existingUser) {
              Write-Host "âš ï¸  Ú©Ø§Ø±Ø¨Ø± 'RDP' Ù‚Ø¯ÛŒÙ…ÛŒ Ù¾ÛŒØ¯Ø§ Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø­Ø°Ù..."
              Remove-LocalUser -Name "RDP"
              Write-Host "âœ… Ú©Ø§Ø±Ø¨Ø± Ù‚Ø¯ÛŒÙ…ÛŒ Ø­Ø°Ù Ø´Ø¯."
          }
          
          # 5. Ø§ÛŒØ¬Ø§Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø«Ø§Ø¨Øª
          try {
              New-LocalUser -Name "RDP" -Password $securePassword -AccountNeverExpires -PasswordNeverExpires:$false
              Write-Host "âœ… Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ 'RDP' Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯."
          } catch {
              Write-Error "âŒ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ø´Ú©Ø³Øª Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯: $_"
              exit 1
          }
          
          # 6. Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Administrators (Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ†)
          try {
              Add-LocalGroupMember -Group "Administrators" -Member "RDP" -ErrorAction Stop
              Write-Host "âœ… Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ 'Administrators' Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯."
          } catch {
              Write-Error "âŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Administrators Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯: $_"
          }
          
          # 7. Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Remote Desktop Users (Ø§Ø¬Ø§Ø²Ù‡ RDP)
          try {
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP" -ErrorAction Stop
              Write-Host "âœ… Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ 'Remote Desktop Users' Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯."
          } catch {
              Write-Error "âŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡ Remote Desktop Users Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯: $_"
          }
          
          # 8. Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù†Ù‡Ø§ÛŒÛŒ (Ø±Ù…Ø² Ø¯Ø± Ù„Ø§Ú¯ Ù†Ø´Ø§Ù† Ø¯Ø§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ - Ø§Ù…Ù†)
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "ğŸ”¥ Ú©Ø§Ø±Ø¨Ø± RDP Ø¨Ø§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø«Ø§Ø¨Øª Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ø´Ø¯."
          Write-Host "ğŸ‘¤ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ: RDP"
          Write-Host "ğŸ” Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±: [Ù…Ù‚Ø¯Ø§Ø± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø¯Ø± GitHub Secrets]"
          Write-Host "=========================================="
          
          # Keep runner active indefinitely (or until manually cancelled)
          while ($true) {
              Write-Host "[$(Get-Date)] RDP Active - Use Ctrl+C in workflow to terminate"
              Start-Sleep -Seconds 300
          }


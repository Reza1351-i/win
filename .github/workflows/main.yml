name: RDP with Auto-Restart

on:
  workflow_dispatch:
  schedule:
    # Ø§Ø¬Ø±Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ø± 5 Ø³Ø§Ø¹Øª Ùˆ 30 Ø¯Ù‚ÛŒÙ‚Ù‡
    - cron: '0 */5 * * *'
    - cron: '30 */5 * * *'

env:
  RDP_USERNAME: "RDP"

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 330  # 5.5 Ø³Ø§Ø¹Øª (Ú©Ù…ØªØ± Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯ÛŒØª 6 Ø³Ø§Ø¹ØªÙ‡ GitHub)

    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ secrets.GITHUB_TOKEN }}
          all_but_latest: true

      - name: Configure Core RDP Settings
        run: |
          # ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force
          
          # ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Network Level Authentication (Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨ÛŒØ´ØªØ±)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "UserAuthentication" -Value 0 -Force
          
          # ØªÙ†Ø¸ÛŒÙ… Security Layer
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "SecurityLayer" -Value 0 -Force

          # Ø­Ø°Ù Ù‚Ø§Ù†ÙˆÙ† Ù‚Ø¨Ù„ÛŒ ÙØ§ÛŒØ±ÙˆØ§Ù„ (Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯)
          netsh advfirewall firewall delete rule name="RDP-Tailscale" 2>$null
          
          # Ø§ÛŒØ¬Ø§Ø¯ Ù‚Ø§Ù†ÙˆÙ† Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ÙØ§ÛŒØ±ÙˆØ§Ù„
          netsh advfirewall firewall add rule name="RDP-Tailscale" `
            dir=in action=allow protocol=TCP localport=3389

          # Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Ø³Ø±ÙˆÛŒØ³ Remote Desktop
          Restart-Service -Name TermService -Force -ErrorAction SilentlyContinue

      - name: Create RDP User with Secure Password
        run: |
          # ØªØ¹Ø±ÛŒÙ Ù…Ø¬Ù…ÙˆØ¹Ù‡ Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ù¾Ø³ÙˆØ±Ø¯
          $charSet = @{
              Upper   = [char[]](65..90)      # A-Z
              Lower   = [char[]](97..122)     # a-z
              Number  = [char[]](48..57)      # 0-9
              Special = ([char[]](33..47) + [char[]](58..64) +
                         [char[]](91..96) + [char[]](123..126)) # Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ Ø®Ø§Øµ
          }
          
          # ØªÙˆÙ„ÛŒØ¯ Ù¾Ø³ÙˆØ±Ø¯ ØªØµØ§Ø¯ÙÛŒ
          $rawPassword = @()
          $rawPassword += $charSet.Upper | Get-Random -Count 4
          $rawPassword += $charSet.Lower | Get-Random -Count 4
          $rawPassword += $charSet.Number | Get-Random -Count 4
          $rawPassword += $charSet.Special | Get-Random -Count 4
          $password = -join ($rawPassword | Sort-Object { Get-Random })
          
          # ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Secure String
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          # Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø± Ù‚Ø¨Ù„ÛŒ (Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯)
          $existingUser = Get-LocalUser -Name "$env:RDP_USERNAME" -ErrorAction SilentlyContinue
          if ($existingUser) {
              Remove-LocalUser -Name "$env:RDP_USERNAME"
          }
          
          # Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
          New-LocalUser -Name "$env:RDP_USERNAME" -Password $securePass -AccountNeverExpires
          
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
          Add-LocalGroupMember -Group "Administrators" -Member "$env:RDP_USERNAME"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "$env:RDP_USERNAME"
          
          # Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø± Environment Variables
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          echo "RDP_CREDS=User: $env:RDP_USERNAME | Password: $password" >> $env:GITHUB_ENV
          
          # ØªØ£ÛŒÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±
          if (-not (Get-LocalUser -Name "$env:RDP_USERNAME")) {
              Write-Error "User creation failed"
              exit 1
          }

      - name: Install Tailscale
        run: |
          # Ø¯Ø§Ù†Ù„ÙˆØ¯ Tailscale
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          
          # Ù†ØµØ¨ Tailscale
          Start-Process msiexec.exe `
            -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" `
            -Wait `
            -NoNewWindow
          
          # Ø­Ø°Ù ÙØ§ÛŒÙ„ Ù†ØµØ¨â€ŒÚ©Ù†Ù†Ø¯Ù‡
          Remove-Item $installerPath -Force
          
          # Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù…Ù„ Ø´Ø¯Ù† ÙØ±Ø¢ÛŒÙ†Ø¯ Ù†ØµØ¨
          Start-Sleep -Seconds 10

      - name: Establish Tailscale Connection
        run: |
          # Ø§ØªØµØ§Ù„ Ø¨Ù‡ Tailscale
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} `
            --hostname=gh-runner-$env:GITHUB_RUN_ID
          
          # Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª IP Ø§Ø² Tailscale
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 10) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              Start-Sleep -Seconds 5
              $retries++
          }
          
          # Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯Ù† Ø§ØªØµØ§Ù„
          if (-not $tsIP) {
              Write-Error "Tailscale IP not assigned. Exiting."
              exit 1
          }
          
          # Ø°Ø®ÛŒØ±Ù‡ IP Ø¯Ø± Environment Variables
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV

      - name: Verify RDP Accessibility
        run: |
          # Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØªØµØ§Ù„
          Write-Host "=== RDP CONNECTION DETAILS ==="
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          Write-Host "$env:RDP_CREDS"
          Write-Host "=============================="
          
          # Ø¢Ø²Ù…Ø§ÛŒØ´ Ø§ØªØµØ§Ù„ TCP Ø¨Ù‡ Ù¾ÙˆØ±Øª RDP
          $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue
          
          if (-not $testResult.TcpTestSucceeded) {
              Write-Warning "TCP connection test failed initially. Retrying in 30 seconds..."
              Start-Sleep -Seconds 30
              $testResult = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389
              
              if (-not $testResult.TcpTestSucceeded) {
                  Write-Error "TCP connection to RDP port 3389 failed after retry"
                  exit 1
              }
          }
          
          Write-Host "âœ… TCP connectivity successful!"

      - name: Maintain Connection Until Timeout
        run: |
          Write-Host "`nğŸš€ RDP SESSION ACTIVE"
          Write-Host "========================"
          Write-Host "Address: $env:TAILSCALE_IP"
          Write-Host "Username: $env:RDP_USERNAME"
          Write-Host "Password: $env:RDP_PASSWORD"
          Write-Host "========================`n"
          
          Write-Host "â° This session will automatically restart every 5.5 hours"
          Write-Host "ğŸ“‹ Next auto-restart scheduled via GitHub Actions cron"
          Write-Host "ğŸ”„ Manual restart: Trigger 'RDP with Auto-Restart' workflow"
          
          # Ø­Ù„Ù‚Ù‡ Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø±Ù†Ø¯Ù‡ Ø¨Ø§ Ø´Ù…Ø§Ø±Ø´ Ù…Ø¹Ú©ÙˆØ³
          $totalSeconds = 330 * 60  # 5.5 Ø³Ø§Ø¹Øª Ø¨Ù‡ Ø«Ø§Ù†ÛŒÙ‡
          $interval = 300  # Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ù‡Ø± 5 Ø¯Ù‚ÛŒÙ‚Ù‡
          
          for ($i = 0; $i -lt $totalSeconds; $i += $interval) {
              $remainingMinutes = [math]::Ceiling(($totalSeconds - $i) / 60)
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] RDP active - $remainingMinutes minutes remaining until auto-restart"
              Start-Sleep -Seconds $interval
          }
          
          Write-Host "â³ Session timeout reached. Workflow will auto-restart via cron schedule."
